<!DOCTYPE html>


<!--
 | Generated by Apache Maven Doxia Site Renderer 2.0.0-M19 from src/site/markdown/dynamic-sql.md at 27 Nov 2024
 | Rendered using Apache Maven Fluido Skin 2.0.0-M9
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 2.0.0-M19" />
    <meta name="author" content="Clinton Begin" />
    <title>MyBatis 3 | Dynamic SQL – mybatis</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-2.0.0-M9.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />
    <script src="./js/apache-maven-fluido-2.0.0-M9.min.js"></script>
  </head>
  <body>
    <div class="container-fluid container-fluid-top">
      <header>
        <div id="banner">
          <div class="pull-left"></div>
          <div class="pull-right"><div id="bannerRight"><h1><a href="https://blog.mybatis.org/" class="externalLink"><img class="imageLink" src="../images/mybatis-logo.png" alt="MyBatis logo" /> MyBatis</a></h1></div></div>
          <div class="clear"><hr/></div>
        </div>

        <div id="breadcrumbs">
          <ul class="breadcrumb">
        <li id="publishDate">Last Published: 26 Nov 2024<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 3.5.17</li>
          </ul>
        </div>
      </header>
      <div class="row-fluid">
        <header id="leftColumn" class="span2">
          <nav class="well sidebar-nav">
  <ul class="nav nav-list">
   <li class="nav-header">Reference Documentation</li>
    <li><a href="index.html">Introduction</a></li>
    <li><a href="getting-started.html">Getting Started</a></li>
    <li><a href="configuration.html"><span class="icon-chevron-right"></span>Configuration XML</a></li>
    <li><a href="sqlmap-xml.html"><span class="icon-chevron-right"></span>Mapper XML Files</a></li>
    <li class="active"><a>Dynamic SQL</a></li>
    <li><a href="java-api.html"><span class="icon-chevron-right"></span>Java API</a></li>
    <li><a href="statement-builders.html">SQL Builder Class</a></li>
    <li><a href="logging.html">Logging</a></li>
   <li class="nav-header">Project Documentation</li>
    <li><a href="project-info.html"><span class="icon-chevron-right"></span>Project Information</a></li>
    <li><a href="project-reports.html"><span class="icon-chevron-right"></span>Project Reports</a></li>
  </ul>
          </nav>
          <div class="well sidebar-nav">
            <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
<a href="https://maven.apache.org/" class="builtBy" target="_blank"><img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </header>
        <main id="bodyColumn" class="span10">
<section><a id="Avoid_blank_site"></a>
<h1 class="d-none">Avoid blank site</h1>
<section><a id="Dynamic_SQL"></a>
<h2>Dynamic SQL</h2>
<p>One of the most powerful features of MyBatis has always been its Dynamic SQL capabilities. If you have any experience with JDBC or any similar framework, you understand how painful it is to conditionally concatenate strings of SQL together, making sure not to forget spaces or to omit a comma at the end of a list of columns. Dynamic SQL can be downright painful to deal with.</p>
<p>While working with Dynamic SQL will never be a party, MyBatis certainly improves the situation with a powerful Dynamic SQL language that can be used within any mapped SQL statement.</p>
<p>The Dynamic SQL elements should be familiar to anyone who has used JSTL or any similar XML based text processors. In previous versions of MyBatis, there were a lot of elements to know and understand. MyBatis 3 greatly improves upon this, and now there are less than half of those elements to work with. MyBatis employs powerful OGNL based expressions to eliminate most of the other elements:</p>
<ul>

<li>if</li>
<li>choose (when, otherwise)</li>
<li>trim (where, set)</li>
<li>foreach</li>
</ul><section><a id="if"></a>
<h3>if</h3>
<p>The most common thing to do in dynamic SQL is conditionally include a part of a where clause. For example:</p>

<pre><code class="language-xml">&lt;select id=&quot;findActiveBlogWithTitleLike&quot;
     resultType=&quot;Blog&quot;&gt;
  SELECT * FROM BLOG
  WHERE state = &#x2018;ACTIVE&#x2019;
  &lt;if test=&quot;title != null&quot;&gt;
    AND title like #{title}
  &lt;/if&gt;
&lt;/select&gt;
</code></pre>
<p>This statement would provide an optional text search type of functionality. If you passed in no title, then all active Blogs would be returned. But if you do pass in a title, it will look for a title like that (for the keen eyed, yes in this case your parameter value would need to include any masking or wildcard characters).</p>
<p>What if we wanted to optionally search by title and author? First, I&#x2019;d change the name of the statement to make more sense. Then simply add another condition.</p>

<pre><code class="language-xml">&lt;select id=&quot;findActiveBlogLike&quot;
     resultType=&quot;Blog&quot;&gt;
  SELECT * FROM BLOG WHERE state = &#x2018;ACTIVE&#x2019;
  &lt;if test=&quot;title != null&quot;&gt;
    AND title like #{title}
  &lt;/if&gt;
  &lt;if test=&quot;author != null and author.name != null&quot;&gt;
    AND author_name like #{author.name}
  &lt;/if&gt;
&lt;/select&gt;
</code></pre></section><section><a id="choose.2C_when.2C_otherwise"></a>
<h3>choose, when, otherwise</h3>
<p>Sometimes we don&#x2019;t want all of the conditionals to apply, instead we want to choose only one case among many options. Similar to a switch statement in Java, MyBatis offers a choose element.</p>
<p>Let&#x2019;s use the example above, but now let&#x2019;s search only on title if one is provided, then only by author if one is provided. If neither is provided, let&#x2019;s only return featured blogs (perhaps a strategically list selected by administrators, instead of returning a huge meaningless list of random blogs).</p>

<pre><code class="language-xml">&lt;select id=&quot;findActiveBlogLike&quot;
     resultType=&quot;Blog&quot;&gt;
  SELECT * FROM BLOG WHERE state = &#x2018;ACTIVE&#x2019;
  &lt;choose&gt;
    &lt;when test=&quot;title != null&quot;&gt;
      AND title like #{title}
    &lt;/when&gt;
    &lt;when test=&quot;author != null and author.name != null&quot;&gt;
      AND author_name like #{author.name}
    &lt;/when&gt;
    &lt;otherwise&gt;
      AND featured = 1
    &lt;/otherwise&gt;
  &lt;/choose&gt;
&lt;/select&gt;
</code></pre></section><section><a id="trim.2C_where.2C_set"></a>
<h3>trim, where, set</h3>
<p>The previous examples have been conveniently dancing around a notorious dynamic SQL challenge. Consider what would happen if we return to our &#x201c;if&#x201d; example, but this time we make &#x201c;ACTIVE = 1&#x201d; a dynamic condition as well.</p>

<pre><code class="language-xml">&lt;select id=&quot;findActiveBlogLike&quot;
     resultType=&quot;Blog&quot;&gt;
  SELECT * FROM BLOG
  WHERE
  &lt;if test=&quot;state != null&quot;&gt;
    state = #{state}
  &lt;/if&gt;
  &lt;if test=&quot;title != null&quot;&gt;
    AND title like #{title}
  &lt;/if&gt;
  &lt;if test=&quot;author != null and author.name != null&quot;&gt;
    AND author_name like #{author.name}
  &lt;/if&gt;
&lt;/select&gt;
</code></pre>
<p>What happens if none of the conditions are met? You would end up with SQL that looked like this:</p>

<pre><code class="language-sql">SELECT * FROM BLOG
WHERE
</code></pre>
<p>This would fail. What if only the second condition was met? You would end up with SQL that looked like this:</p>

<pre><code class="language-sql">SELECT * FROM BLOG
WHERE
AND title like &#x2018;someTitle&#x2019;
</code></pre>
<p>This would also fail. This problem is not easily solved with conditionals, and if you&#x2019;ve ever had to write it, then you likely never want to do so again.</p>
<p>MyBatis has a simple answer that will likely work in 90% of the cases. And in cases where it doesn&#x2019;t, you can customize it so that it does. With one simple change, everything works fine:</p>

<pre><code class="language-xml">&lt;select id=&quot;findActiveBlogLike&quot;
     resultType=&quot;Blog&quot;&gt;
  SELECT * FROM BLOG
  &lt;where&gt;
    &lt;if test=&quot;state != null&quot;&gt;
         state = #{state}
    &lt;/if&gt;
    &lt;if test=&quot;title != null&quot;&gt;
        AND title like #{title}
    &lt;/if&gt;
    &lt;if test=&quot;author != null and author.name != null&quot;&gt;
        AND author_name like #{author.name}
    &lt;/if&gt;
  &lt;/where&gt;
&lt;/select&gt;
</code></pre>
<p>The <em>where</em> element knows to only insert &#x201c;WHERE&#x201d; if there is any content returned by the containing tags. Furthermore, if that content begins with &#x201c;AND&#x201d; or &#x201c;OR&#x201d;, it knows to strip it off.</p>
<p>If the <em>where</em> element does not behave exactly as you like, you can customize it by defining your own trim element. For example, the trim equivalent to the <em>where</em> element is:</p>

<pre><code class="language-xml">&lt;trim prefix=&quot;WHERE&quot; prefixOverrides=&quot;AND |OR &quot;&gt;
  ...
&lt;/trim&gt;
</code></pre>
<p>The <em>prefixOverrides</em> attribute takes a pipe delimited list of text to override, where whitespace <u>is</u> relevant. The result is the removal of anything specified in the <em>prefixOverrides</em> attribute, and the insertion of anything in the <em>prefix</em> attribute.</p>
<p>There is a similar solution for dynamic update statements called <em>set</em>. The <em>set</em> element can be used to dynamically include columns to update, and leave out others. For example:</p>

<pre><code class="language-xml">&lt;update id=&quot;updateAuthorIfNecessary&quot;&gt;
  update Author
    &lt;set&gt;
      &lt;if test=&quot;username != null&quot;&gt;username=#{username},&lt;/if&gt;
      &lt;if test=&quot;password != null&quot;&gt;password=#{password},&lt;/if&gt;
      &lt;if test=&quot;email != null&quot;&gt;email=#{email},&lt;/if&gt;
      &lt;if test=&quot;bio != null&quot;&gt;bio=#{bio}&lt;/if&gt;
    &lt;/set&gt;
  where id=#{id}
&lt;/update&gt;
</code></pre>
<p>Here, the <em>set</em> element will dynamically prepend the SET keyword, and also eliminate any extraneous commas that might trail the value assignments after the conditions are applied.</p>
<p>Alternatively, you can achieve the same effect by using <em>trim</em> element:</p>

<pre><code class="language-xml">&lt;trim prefix=&quot;SET&quot; suffixOverrides=&quot;,&quot;&gt;
  ...
&lt;/trim&gt;
</code></pre>
<p>Notice that in this case we&#x2019;re overriding a suffix, while we&#x2019;re still appending a prefix.</p></section><section><a id="foreach"></a>
<h3>foreach</h3>
<p>Another common necessity for dynamic SQL is the need to iterate over a collection, often to build an IN condition. For example:</p>

<pre><code class="language-xml">&lt;select id=&quot;selectPostIn&quot; resultType=&quot;domain.blog.Post&quot;&gt;
  SELECT *
  FROM POST P
  &lt;where&gt;
    &lt;foreach item=&quot;item&quot; index=&quot;index&quot; collection=&quot;list&quot;
        open=&quot;ID in (&quot; separator=&quot;,&quot; close=&quot;)&quot; nullable=&quot;true&quot;&gt;
          #{item}
    &lt;/foreach&gt;
  &lt;/where&gt;
&lt;/select&gt;
</code></pre>
<p>The <em>foreach</em> element is very powerful, and allows you to specify a collection, declare item and index variables that can be used inside the body of the element. It also allows you to specify opening and closing strings, and add a separator to place in between iterations. The element is smart in that it won&#x2019;t accidentally append extra separators.</p>
<p><span class="label important">NOTE</span> You can pass any Iterable object (for example List, Set, etc.), as well as any Map or Array object to foreach as collection parameter. When using an Iterable or Array, index will be the number of current iteration and value item will be the element retrieved in this iteration. When using a Map (or Collection of Map.Entry objects), index will be the key object and item will be the value object.</p>
<p>This wraps up the discussion regarding the XML configuration file and XML mapping files. The next section will discuss the Java API in detail, so that you can get the most out of the mappings that you&#x2019;ve created.</p></section><section><a id="script"></a>
<h3>script</h3>
<p>For using dynamic SQL in annotated mapper class, <em>script</em> element can be used. For example:</p>

<pre><code class="language-java">    @Update({&quot;&lt;script&gt;&quot;,
      &quot;update Author&quot;,
      &quot;  &lt;set&gt;&quot;,
      &quot;    &lt;if test='username != null'&gt;username=#{username},&lt;/if&gt;&quot;,
      &quot;    &lt;if test='password != null'&gt;password=#{password},&lt;/if&gt;&quot;,
      &quot;    &lt;if test='email != null'&gt;email=#{email},&lt;/if&gt;&quot;,
      &quot;    &lt;if test='bio != null'&gt;bio=#{bio}&lt;/if&gt;&quot;,
      &quot;  &lt;/set&gt;&quot;,
      &quot;where id=#{id}&quot;,
      &quot;&lt;/script&gt;&quot;})
    void updateAuthorValues(Author author);
</code></pre></section><section><a id="bind"></a>
<h3>bind</h3>
<p>The <code>bind</code> element lets you create a variable out of an OGNL expression and bind it to the context. For example:</p>

<pre><code class="language-xml">&lt;select id=&quot;selectBlogsLike&quot; resultType=&quot;Blog&quot;&gt;
  &lt;bind name=&quot;pattern&quot; value=&quot;'%' + _parameter.getTitle() + '%'&quot; /&gt;
  SELECT * FROM BLOG
  WHERE title LIKE #{pattern}
&lt;/select&gt;
</code></pre></section><section><a id="Multi-db_vendor_support"></a>
<h3>Multi-db vendor support</h3>
<p>If a databaseIdProvider was configured a &#x201c;_databaseId&#x201d; variable is available for dynamic code, so you can build different statements depending on database vendor. Have a look at the following example:</p>

<pre><code class="language-xml">&lt;insert id=&quot;insert&quot;&gt;
  &lt;selectKey keyProperty=&quot;id&quot; resultType=&quot;int&quot; order=&quot;BEFORE&quot;&gt;
    &lt;if test=&quot;_databaseId == 'oracle'&quot;&gt;
      select seq_users.nextval from dual
    &lt;/if&gt;
    &lt;if test=&quot;_databaseId == 'db2'&quot;&gt;
      select nextval for seq_users from sysibm.sysdummy1&quot;
    &lt;/if&gt;
  &lt;/selectKey&gt;
  insert into users values (#{id}, #{name})
&lt;/insert&gt;
</code></pre></section><section><a id="Pluggable_Scripting_Languages_For_Dynamic_SQL"></a>
<h3>Pluggable Scripting Languages For Dynamic SQL</h3>
<p>Starting from version 3.2 MyBatis supports pluggable scripting languages, so you can plug a language driver and use that language to write your dynamic SQL queries.</p>
<p>You can plug a language by implementing the following interface:</p>

<pre><code class="language-java">public interface LanguageDriver {
  ParameterHandler createParameterHandler(MappedStatement mappedStatement, Object parameterObject, BoundSql boundSql);
  SqlSource createSqlSource(Configuration configuration, XNode script, Class&lt;?&gt; parameterType);
  SqlSource createSqlSource(Configuration configuration, String script, Class&lt;?&gt; parameterType);
}
</code></pre>
<p>Once you have your custom language driver you can set it to be the default by configuring it in the mybatis-config.xml file:</p>

<pre><code class="language-xml">&lt;typeAliases&gt;
  &lt;typeAlias type=&quot;org.sample.MyLanguageDriver&quot; alias=&quot;myLanguage&quot;/&gt;
&lt;/typeAliases&gt;
&lt;settings&gt;
  &lt;setting name=&quot;defaultScriptingLanguage&quot; value=&quot;myLanguage&quot;/&gt;
&lt;/settings&gt;
</code></pre>
<p>Instead of changing the default, you can specify the language for an specific statement by adding the <code>lang</code> attribute as follows:</p>

<pre><code class="language-xml">&lt;select id=&quot;selectBlog&quot; lang=&quot;myLanguage&quot;&gt;
  SELECT * FROM BLOG
&lt;/select&gt;
</code></pre>
<p>Or, in the case you are using mappers, using the <code>@Lang</code> annotation:</p>

<pre><code class="language-java">public interface Mapper {
  @Lang(MyLanguageDriver.class)
  @Select(&quot;SELECT * FROM BLOG&quot;)
  List&lt;Blog&gt; selectBlog();
}
</code></pre>
<p><span class="label important">NOTE</span> You can use Apache Velocity as your dynamic language. Have a look at the MyBatis-Velocity project for the details.</p>
<p>All the xml tags you have seen in the previous sections are provided by the default MyBatis language that is provided by the driver <code>org.apache.ibatis.scripting.xmltags.XmlLanguageDriver</code> which is aliased as <code>xml</code>.</p></section></section></section>
        </main>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>©      2009–2024
<a href="https://www.mybatis.org/">MyBatis.org</a>
</p>
        </div>
      </div>
    </footer>
<script>
  if(anchors) {
    anchors.add();
  }
</script>
  </body>
</html>
